# Orders

## Resource

The `order` resource along with it's subresources is the central resource of to.photo. It's parameters are listed in the following table. Each API-function always accepts or returns a complete `order`structure. Depending on the function some parameters may be omitted (see specific documentation of the functions)

| Parameter     | Type     | Responsible Role       | Description  |
| ------------- | -------- | ---------------------- | ------------ |
| orderId       | long     | S                      | Unique id of this resource. Always ands with 0. The up to 9 possible subcarts fill the last digit |
| orderdate     | long     | C (or S if not given)  | Unix timestamp of the order's date |
| mandator      | int      | C                      | The mandator given by the to.photo admin. See [Portal / Mandator](#portal-mandator) |
| portal        | int      | C                      | The portal given by the to.photo admin. See [Portal / Mandator](#portal-mandator) |
| status        | string   | S                      | See [Status](#status) for more details |
| statusHistory | array    | S                      | Array of `StatusEntry`-subresources. See [StatusEntry](#statusentry) for more details |
| customer      | customer | C                      | See [Customer](#customer) for more details |
| projects      | array    | C                      | Array of `Project`-subresources. See [Project](#project) for more details |
| bunches       | array    | C                      | Array of `Bunch`-subresources. See [Bunch](#bunch) for more details |
| payload       | array    | C                      | Array of `Payload`-subresources. See [Payload](#payload) for more details |
| cart          | cart     | S                      | See [Cart](#cart) for more details |

## Status

An `order` can have multiple status. Some status require or need an explicit acknowledge action, because they may lead to additional steps on mandator side (e.g. signal shipment to external shop system).

| Name        | Auto-Acknowledged | Description  |
| ----------- | ----------------- | ------------ |
| Temporary   | Y                 | The order is in a creational state. It hasn't been ordered in a legal manner yet. Customer data and payment-information may be added |
| Transferred | Y                 | The order's payload (binary data, images, etc.) has been finally transferred. Processing may start now |
| New         | Y                 | Intermediate state. Ready to be further processed. |
| Enqueued    | Y                 | The order has been enqueued for processing and exporting |
| Exporting   | Y                 | The order is actively processing and the output will be generated by the producer (e.g. written to disk or uploaded to another server) | 
| Exported    | Y                 | The order has been exported |
| Producing   | Y                 | The order has been picked up by the producer and will be produced somewhen in the near future |
| Produced    | N                 | The order has been succesfully produced. |
| Shipped     | N                 | The order has been handed to the freight forwarder |
| Delivered   | Y                 | The order has been handed over to the user |
| Failed      | N                 | An exception occured while processing the order. Additional information maybe found via the StatusHistory |
| Test        | Y                 | The order is for testing purposes and won't be charged or physically produced |
| Canceled    | Y                 | The order is canceled and won't be processed any further |


## Subresources

Subresources only 'live' within their parent `order` resource.

### StatusEntry

> StatusEntry JSON

```json
  {
    "acknowledged": true, 
    "date": "1525505632181", 
    "status": "Temporary"
  }
```

| Parameter     | Type     | Responsible Role       | Description  |
| ------------- | -------- | ---------------------- | ------------ |
| status        | string   | S                      | See [Status](#status) for mode details |
| date          | long     | S                      | Unix timestamp of this status effective date |
| acknowledged  | bool     | S                      | Has this status already been acknowledged (automatically or manually) |
| metadata      | map      | S                      | Optional metadata in a free key-value manner (e.g. tracking numbers)| 

### Customer

> Customer and Address JSON

```json
  "customer": {
    "billingaddress": {
      "city": "Berlin", 
      "country": "DE", 
      "firstname": "Max", 
      "lastname": "Mustermann", 
      "street": "Musterstraße 33", 
      "zipcode": "12587"
    }, 
    "deliveryaddress": {
      "city": "Berlin", 
      "country": "DE", 
      "firstname": "Gunda", 
      "lastname": "Gaukelei", 
      "street": "Schloß 666", 
      "zipcode": "12587"
    }, 
    "email": "m.mustermann@example.com"
  }
```

The `Customer` consists of two separate addresses for billing and delivery along with a separate email-address.

| Parameter       | Type     | Responsible Role       | Description  |
| --------------- | -------- | ---------------------- | ------------ |
| billingaddress  | address  | C                      | See [Address](#address) for mode details |
| deliveryaddress | address  | C                      | See [Address](#address) for mode details |
| email           | string   | C                      | The customer's email-address |

### Address

The attributes have the same meaning as in other customer or address related systems. The following table therefore does only provide some extra details on specific attributes. 

| Parameter       | Type     | Description  |
| --------------- | -------- | ------------ |
| country         | string   | Must be provided as [ISO 3166-1 ALPHA-2](https://en.wikipedia.org/wiki/ISO_3166-1) |

### Project

> Project and Processor JSON

```json
{
  "count": 1, 
  "identifier": "custom1", 
  "title": "Zaubertasse mit pers\u00f6nlichem Foto zum selbst gestalten (Magic Fototasse mit Thermoeffekt, Text...",
  "processor": {
    "identifier": "photo.to.amazonmarketplace.AmazonStandardCupProcessor", 
    "metadata": {
      "passthrough": "true", 
      "sku": "14621100"
    }
  }
}
````

A `Project` describes one logical unit in the domain of the mandator (e.g. one series of photos of a specific event). Projects are a preliminary form of subcart-items and are evaluated according to the given meta-information and processors.

| Parameter       | Type      | Responsible Role       | Description  |
| --------------- | --------- | ---------------------- | ------------ |
| count           | number    | C                      | Desired occurence of this project. While the final products are determined by the processor. Their counts are multiplied with this project count |
| identifier      | string    | M                      | An unique identifier of this project which is used throughout this order |
| title           | string    | M (indirect C)         | A description to be used as a human readable explanation |
| processor       | processor | M (indirect C)         | The [Processor](#processor) to be used when processing this project |

### Processor

A `Processor` describes the server-side implementation, which analyses a project's data and determines and generates the final products.

| Parameter       | Type      | Description  |
| --------------- | --------- | ------------ |
| identifier      | string    | Identifier of the processor. Currently the full qualified classname of the Java class. May be extended in the future to other schemes.
| metadata        | map       | Optional metadata in a free key-value manner (e.g. feature flags, color schemes, ...)| 

### Bunch

> Bunch and BunchItem JSON

```json
{
  "project": "custom1",
  "items": [
    {
      "type": "Payload",
      "mimetype": "application/zip", 
      "reference": "custom1.zip",
      "metadata": {
        "main": true
      }
    }
  ]
}
```

A `Bunch` describes all items which belong to a project. The `Processor` will use the bunches to decide which product he will create. Multiple bunches may belong to a project. They represent one logical part of a project. In case of a photo book the page count could be determined based on the count and variety of the bunches and it's [BunchItems](#bunchitem)

| Parameter       | Type      | Responsible Role       | Description  |
| --------------- | --------- | ---------------------- | ------------ |
| project         | string    | M                      | Identifier of the project this bunch belongs to |
| items           | array     | M                      | Array of `BunchItems`-subresources.  See [BunchItem](#bunchitem) for more details |

### BunchItem

A `BunchItem` is a subpart of a `Bunch`. While one `BunchItem` could consist of a photograph, another could add a title string or some cliparts to be rendered ontop of the photograph. For binary data `BunchItems` just "link" to items of [Payload](#payload). They may reference to network content as well (see `type` parameter), which has to be downloaded upon processing.

| Parameter       | Type      | Responsible Role       | Description  |
| --------------- | --------- | ---------------------- | ------------ |
| type            | string    | M                      | Describes the type of this item. May be one of 'Payload', 'Url' or (direct) 'Text' |
| mimetype        | string    | M                      | Must be provided as [RFC6838](http://www.iana.org/assignments/media-types/media-types.xhtml) |
| reference       | string    | M                      | The 'body' of this item. Describes filename, url or content depending on the type parameter. |
| metadata        | map       | M                      | Optional metadata in a free key-value manner (e.g. tags, descriptors, significance) | 

### Payload

```json
{
  "mimetype": "application/zip", 
  "name": "custom1.zip"
}
````

A `Payload` describes one file in the [finally posted](#finalizeorder) zip file. In difference to a `BunchItems` a `Payload` has no direct connection to a `Project`. This decoupling enables shared resources. As duplicate filenames within a zip file are not allowd there won't be 2 `Payloads` with the same name.

| Parameter       | Type      | Responsible Role       | Description  |
| --------------- | --------- | ---------------------- | ------------ |
| mimetype        | string    | M                      | Must be provided as [RFC6838](http://www.iana.org/assignments/media-types/media-types.xhtml) |
| name            | string    | M                      | The file name |


## Create Order

> Request

```yaml
Path:    POST /v1/orders
Headers: Accept: application/json
Headers: Content-Type: application/json
```

> Response

```yaml
Headers: Content-Type: application/json
```

```json
{
  "orderId": "270",
  "bunches": [
    {
      "items": [
        {
          "mimetype": "application/zip",
          "reference": "custom1.zip",
          "type": "Payload"
        }
      ],
      "project": "custom1"
    }
  ],
  "cart": {
    "subcarts": [
      {
        "items": [
          {
            "count": 1,
            "price": 11900,
            "processorIndex": 0,
            "project": "custom1",
            "sku": "14631000"
          }
        ],
        "orderId": 123,
        "paymentOrderId": "testorder",
        "producer": "Allcop",
        "producerOrderId": 123,
        "producerOrderUniqueIdentifier": "94440000123",
        "shipping": 3450
      }
    ]
  },
  "customer": {
    "billingaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "deliveryaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "email": "test@test.test"
  },
  "mandator": 0,
  "orderdate": 1518800013000,
  "payload": [
    {
      "mimetype": "application/zip",
      "name": "custom1.zip"
    }
  ],
  "portal": 1000,
  "projects": [
    {
      "count": 1,
      "identifier": "custom1",
      "processor": {
        "identifier": "photo.to.amazonmarketplace.AmazonStandardCupProcessor",
        "metadata": {
          "sku": "14631000"
        }
      },
      "title": "Tasse (14631000)"
    }
  ],
  "status": "Enqueued",
  "statusHistory": [
  ]
}
```

Use the `order` resource to initialise a new order. Upon initialization it is not necessary to provide all details of an order. All of the details are added during an `order`s lifecycle.

### Error Response

* **422 UNPROCESSABLE ENTITY**

    The order would lead to more then 9 Subcarts.

> Error Response

```json
{
  "status": "UNPROCESSABLE_ENTITY",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "More than 9 Subcarts are not allowed",
  "debugMessage": "More than 9 Subcarts are not allowed"
}
```



## Checkout Order

> Request

```yaml
Path:    POST /v1/orders/:orderid/checkout
Headers: Accept: application/json
Headers: Content-Type: application/json
```
> Response

```yaml
Headers: Content-Type: application/json
```

```json
{
  "orderId": "270",
  "bunches": [
    {
      "items": [
        {
          "mimetype": "application/zip",
          "reference": "custom1.zip",
          "type": "Payload"
        }
      ],
      "project": "custom1"
    }
  ],
  "cart": {
    "subcarts": [
      {
        "items": [
          {
            "count": 1,
            "price": 11900,
            "processorIndex": 0,
            "project": "custom1",
            "sku": "14631000"
          }
        ],
        "orderId": 123,
        "paymentOrderId": "testorder",
        "producer": "Allcop",
        "producerOrderId": 123,
        "producerOrderUniqueIdentifier": "94440000123",
        "shipping": 3450
      }
    ]
  },
  "customer": {
    "billingaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "deliveryaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "email": "test@test.test"
  },
  "mandator": 0,
  "orderdate": 1518800013000,
  "payload": [
    {
      "mimetype": "application/zip",
      "name": "custom1.zip"
    }
  ],
  "portal": 1000,
  "projects": [
    {
      "count": 1,
      "identifier": "custom1",
      "processor": {
        "identifier": "photo.to.amazonmarketplace.AmazonStandardCupProcessor",
        "metadata": {
          "sku": "14631000"
        }
      },
      "title": "Tasse (14631000)"
    }
  ],
  "status": "Enqueued",
  "statusHistory": [
  ]
}
```

After initialization you will need to enrich the order with checkout data. This contains all data collected in the checkout process.

### URL Params
`orderId=[long]`

### Error Response

* **404 NOT FOUND**

    No order found

```json
{
  "status": "NOT_FOUND",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order not found",
  "debugMessage": "Order not found"
}
```

* **409 CONFLICT**

    The order is not temporary (anymore) and can not be changed.

    _or:_

    The carts are different, please get the actual cart from [order get](#read-order).

```json
{
  "status": "CONFLICT",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Only temporary orders can receive checkout data",
  "debugMessage": "Only temporary orders can receive checkout data"
}
```

```json
{
  "status": "CONFLICT",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Carts are different",
  "debugMessage": "Carts are different"
}
```



## Finalize Order

> Request

```yaml
Path:    POST /v1/orders/:orderid/data
Headers: Accept: application/zip
Headers: Content-Type: application/json
```

> Response

```yaml
Headers: Content-Type: application/json
```

### URL Params
`orderId=[long]`

```json
{
  "orderId": "270",
  "bunches": [
    {
      "items": [
        {
          "mimetype": "application/zip",
          "reference": "custom1.zip",
          "type": "Payload"
        }
      ],
      "project": "custom1"
    }
  ],
  "cart": {
    "subcarts": [
      {
        "items": [
          {
            "count": 1,
            "price": 11900,
            "processorIndex": 0,
            "project": "custom1",
            "sku": "14631000"
          }
        ],
        "orderId": 123,
        "paymentOrderId": "testorder",
        "producer": "Allcop",
        "producerOrderId": 123,
        "producerOrderUniqueIdentifier": "94440000123",
        "shipping": 3450
      }
    ]
  },
  "customer": {
    "billingaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "deliveryaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "email": "test@test.test"
  },
  "mandator": 0,
  "orderdate": 1518800013000,
  "payload": [
    {
      "mimetype": "application/zip",
      "name": "custom1.zip"
    }
  ],
  "portal": 1000,
  "projects": [
    {
      "count": 1,
      "identifier": "custom1",
      "processor": {
        "identifier": "photo.to.amazonmarketplace.AmazonStandardCupProcessor",
        "metadata": {
          "sku": "14631000"
        }
      },
      "title": "Tasse (14631000)"
    }
  ],
  "status": "Enqueued",
  "statusHistory": [
  ]
}
```

After all you need to finalize the order and send it to production.

Therefore you send all the payload image data, packaged as a ZIP archive, to the server. The successful upload will trigger the production process, no further call is needed.

### Error Response
* **404 NOT FOUND**

    No order found

```json
{
  "status": "NOT_FOUND",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order not found",
  "debugMessage": "Order not found"
}
```

* **409 CONFLICT**

    The order is not temporary (anymore) and can not be changed.

```json
{
  "status": "CONFLICT",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Only temporary orders can receive data",
  "debugMessage": "Only temporary orders can receive data"
}
```



## Order Status Acknowledge

> Request

```yaml
Path:    PUT /v1/orders/:orderid/status
Headers: Accept: application/json
Headers: Content-Type: application/json
```
> Response

```yaml
Headers: Content-Type: application/json
```

Acknowledge an order status as processed

### URL Params
Parameter | Type | Description
--------- | -----|------------
orderid | long | The ID of the order which status to acknowledge

### Error Response
```json
{
  "status": "NOT_FOUND",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order not found",
  "debugMessage": "Order not found"
}
```

* **404 NOT FOUND**

    No order found


```json
{
  "status": "CONFLICT",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Entry can not be acknowledged",
  "debugMessage": "Entry can not be acknowledged"
}
```

* **409 CONFLICT**

    The status entry can not be acknowledged



## Read Order

> Request

```yaml
Path:    GET /v1/orders/:orderid
Headers: Accept: application/json
Headers: Content-Type: application/json
```
> Response

```yaml
Headers: Content-Type: application/json
```

```json
{
  "orderId": "270",
  "bunches": [
    {
      "items": [
        {
          "mimetype": "application/zip",
          "reference": "custom1.zip",
          "type": "Payload"
        }
      ],
      "project": "custom1"
    }
  ],
  "cart": {
    "subcarts": [
      {
        "items": [
          {
            "count": 1,
            "price": 11900,
            "processorIndex": 0,
            "project": "custom1",
            "sku": "14631000"
          }
        ],
        "orderId": 123,
        "paymentOrderId": "testorder",
        "producer": "Allcop",
        "producerOrderId": 123,
        "producerOrderUniqueIdentifier": "94440000123",
        "shipping": 3450
      }
    ]
  },
  "customer": {
    "billingaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "deliveryaddress": {
      "city": "Musterstadt",
      "country": "DE",
      "firstname": "Max",
      "lastname": "Mustermann",
      "street": "Musterstrasse 14",
      "zipcode": "12345"
    },
    "email": "test@test.test"
  },
  "mandator": 0,
  "orderdate": 1518800013000,
  "payload": [
    {
      "mimetype": "application/zip",
      "name": "custom1.zip"
    }
  ],
  "portal": 1000,
  "projects": [
    {
      "count": 1,
      "identifier": "custom1",
      "processor": {
        "identifier": "photo.to.amazonmarketplace.AmazonStandardCupProcessor",
        "metadata": {
          "sku": "14631000"
        }
      },
      "title": "Tasse (14631000)"
    }
  ],
  "status": "Enqueued",
  "statusHistory": [
  ]
}
```

Load an order

### URL Params
`orderId=[long]`

### Error Response
* **404 NOT FOUND**

    No order found

```json
{
  "status": "NOT_FOUND",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order not found",
  "debugMessage": "Order not found"
}
```

* **410 GONE**
  
    The Order is already canceled

```json
{
  "status": "GONE",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order is canceled",
  "debugMessage": "Order is canceled"
}
```



## Cancel Order

> Request

```yaml
Path:    DELETE /v1/orders/:orderid
Headers: Accept: application/json
Headers: Content-Type: application/json
```
> Response

```yaml
Headers: Content-Type: none
```

For some reason you maybe want to cancel your shortly placed order.

### URL Params
Parameter | Type | Description
--------- | -----|------------
orderid | long | The ID of the order which should be canceled

### Success Response
#### Code
`204`

#### Content
_No Content_

### Error Response

```json
{
  "status": "NOT_FOUND",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order not found",
  "debugMessage": "Order not found"
}
```

* **404 NOT FOUND**

    No order found

```json
{
  "status": "CONFLICT",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Only temporary orders can receive data",
  "debugMessage": "Only temporary orders can receive data"
}
```

* **409 CONFLICT**

    The order is not temporary (anymore) and can not be changed.

```json
{
  "status": "GONE",
  "timestamp": "2018-01-01 12:34:56.789",
  "message": "Order is canceled",
  "debugMessage": "Order is canceled"
}
```

* **410 GONE**
  
    The Order is already canceled
